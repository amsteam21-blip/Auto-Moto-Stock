var AMOTOS_NEARBY_PLACES=AMOTOS_NEARBY_PLACES||{};!function(t){"use strict";(AMOTOS_NEARBY_PLACES=function(e){this.$element=t(e),this.element=e,this.$map=this.$element.find(".amotos__map-canvas"),this.$content=this.$element.find(".amotos__nbp-content-inner"),0!==this.$map.length&&0!==this.$content.length&&(this.options=this.$map.data("nearby-options"),this.init())}).prototype.init=function(){this.setupMap(),this.nearByPlaces()},AMOTOS_NEARBY_PLACES.prototype.setupMap=function(){var t=this.$map.attr("id");if(""!==t){var e=AMOTOS_MAP.getInstance(t);this.map=e.instance,this.position=new AMOTOS_MAP.LatLng(this.options.position.lat,this.options.position.lng),this.placesService=new AMOTOS_MAP.PlacesService({maxResultCount:20,includedTypes:this.options.types,radius:this.options.radius,rankPreference:this.options.rankPreference,position:this.position,map:this.map})}},AMOTOS_NEARBY_PLACES.prototype.nearByPlaces=function(){var e=this;this.placesService.nearbySearch((function(n){n?(e.map.trigger("updating_markers"),t.each(n,(function(t,n){var a=e.getPlace(n);e.createMarker(a),e.createPlace(a)})),1===e.map.markers.length&&e.map.setCenter(e.map.markers[0].getPosition()),e.map.markers.length>1&&e.map.fitBounds(e.map.bounds),e.map.trigger("updated_markers")):e.$content.append("<span>"+e.options.i18n.no_result+"</span>")}))},AMOTOS_NEARBY_PLACES.prototype.getPlace=function(e){var n=this,a="";t.each(e.types,(function(e,i){if(-1!==t.inArray(i,n.options.types))return a=i,!1}));var i=n.options.fields[a];return{typeLabel:i.label,typeIcon:i.icon,displayName:e.displayName,lat:e.lat,lng:e.lng}},AMOTOS_NEARBY_PLACES.prototype.createMarker=function(t){var e=this,n={position:new AMOTOS_MAP.LatLng(t.lat,t.lng),map:e.map,template:{marker:{type:"image",html:'<img src="'+t.typeIcon+'" >'}}},a=wp.template("amotos__map_popup_simple_template")({content:"<strong>"+t.typeLabel+": </strong>"+t.displayName});n.popup=new AMOTOS_MAP.Popup({content:a,type:"simple"});var i=new AMOTOS_MAP.Marker(n);e.map.markers.push(i),e.map.bounds.extend(i.getPosition())},AMOTOS_NEARBY_PLACES.prototype.createPlace=function(t){var e=this,n=e.getDistance(t),a=wp.template("amotos__nearby_place_item_template")({type:t.typeLabel,name:t.displayName,distant:n,unit:e.options.unit});e.$content.append(a)},AMOTOS_NEARBY_PLACES.prototype.getDistance=function(t){var e=this.options.position.lat,n=this.options.position.lng,a=t.lat,i=t.lng,s=Math.PI*e/180,p=Math.PI*a/180,o=n-i,r=Math.PI*o/180,c=Math.sin(s)*Math.sin(p)+Math.cos(s)*Math.cos(p)*Math.cos(r);c=60*(c=180*(c=Math.acos(c))/Math.PI)*1.1515,"km"===this.options.unit?c*=1.609344:"m"===this.options.unit&&(c=1.609344*c*1e3);var m=Math.round(100*c)/100;return m=m.toLocaleString().replace(/[^\d.]/gi,this.options.separator)},t(document).on("maps:loaded",(function(){t(".amotos__nearby-places").each((function(){new AMOTOS_NEARBY_PLACES(this)}))}))}(jQuery);